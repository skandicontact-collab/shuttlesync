<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>SKANDI Mail</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
/* ============================================================
   SHUTTLESYNC DARK-SPACE UI THEME
============================================================ */
:root {
  --bg-deep:#020617;
  --bg-mid:#071225;
  --bg-soft:#0b1e3c;
  --glass:rgba(8,16,36,0.72);
  --border:rgba(95,199,207,0.35);
  --accent:#5FC7CF;
  --accent-glow:0 0 12px rgba(95,199,207,0.7);
  --text:#eaf4ff;
  --text-soft:#a4b3d4;
  --radius:16px;
  --shadow:0 18px 42px rgba(0,0,0,0.65);
}

/* RESET */
body,html {
  margin:0;padding:0;
  background:var(--bg-deep);
  font-family:'Montserrat',sans-serif;
  color:var(--text);
  overflow:hidden;
}

/* ============================================================
   LAYOUT: SIDEBAR + TOPBAR + CONTENT
============================================================ */
#app {
  display:grid;
  grid-template-columns:240px 1fr;
  grid-template-rows:70px 1fr;
  grid-template-areas:
    "sidebar topbar"
    "sidebar main";
  height:100vh;
}

/* SIDEBAR */
#sidebar {
  grid-area:sidebar;
  background:var(--glass);
  backdrop-filter:blur(18px);
  border-right:1px solid var(--border);
  padding:22px 18px;
}

.sb-title {
  font-size:15px;
  font-weight:700;
  letter-spacing:.06em;
  margin-bottom:20px;
  text-transform:uppercase;
  color:var(--text-soft);
}

.sb-item {
  padding:10px 14px;
  border-radius:12px;
  margin-bottom:6px;
  cursor:pointer;
  transition:.2s;
  font-size:14px;
  color:var(--text-soft);
}

.sb-item.active {
  background:rgba(95,199,207,0.15);
  color:#fff;
  box-shadow:0 0 12px rgba(95,199,207,0.25);
}

.sb-item:hover {
  color:#fff;
  background:rgba(95,199,207,0.12);
}

/* TOPBAR */
#topbar {
  grid-area:topbar;
  background:linear-gradient(135deg,rgba(2,46,100,0.65),rgba(5,18,40,0.9));
  backdrop-filter:blur(18px);
  border-bottom:1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 22px;
}

#user-email {
  font-size:14px;
  font-weight:600;
  opacity:0.85;
}

/* SEARCH */
#search-box {
  background:var(--bg-soft);
  padding:8px 14px;
  border-radius:12px;
  border:1px solid var(--border);
  width:260px;
  color:var(--text);
  outline:none;
}

/* ============================================================
   MAIN AREA (MAILBOX + MESSAGE VIEW)
============================================================ */
#main {
  grid-area:main;
  display:grid;
  grid-template-columns:350px 1fr;
  grid-template-areas:
    "list view";
  height:100%;
}

/* MAIL LIST */
#mail-list {
  grid-area:list;
  border-right:1px solid var(--border);
  overflow-y:auto;
  background:var(--bg-mid);
}

.mail-item {
  padding:14px 16px;
  border-bottom:1px solid rgba(95,199,207,0.1);
  cursor:pointer;
  transition:.15s;
}

.mail-item:hover {
  background:rgba(95,199,207,0.06);
}

.mail-item.unread .mi-subject {
  font-weight:700;
  color:#fff;
}

.mi-from { font-size:13px;color:var(--text-soft); }
.mi-subject { font-size:14px;margin-top:4px;color:var(--text); }
.mi-time { font-size:12px;margin-top:6px;opacity:0.6; }

/* MESSAGE VIEW */
#mail-view {
  grid-area:view;
  padding:24px;
  overflow-y:auto;
  background:var(--bg-soft);
}

#mv-subject {
  font-size:22px;
  font-weight:700;
  margin-bottom:10px;
}

#mv-meta {
  font-size:13px;
  opacity:0.7;
  margin-bottom:20px;
}

#mv-body {
  white-space:pre-wrap;
  font-size:14px;
  line-height:1.55;
}

/* ============================================================
   COMPOSE WINDOW
============================================================ */
#compose-btn {
  width:100%;
  padding:12px;
  background:var(--accent);
  border-radius:12px;
  text-align:center;
  color:#02121f;
  font-weight:700;
  cursor:pointer;
  margin-bottom:22px;
  box-shadow:0 6px 22px rgba(95,199,207,0.3);
}

#compose-modal {
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.65);
  backdrop-filter:blur(18px);
  z-index:99999;
  align-items:center;
  justify-content:center;
}

#compose-box {
  background:var(--bg-mid);
  width:700px;
  border-radius:20px;
  padding:22px;
  box-shadow:var(--shadow);
  border:1px solid var(--border);
}

.comp-field {
  margin-bottom:14px;
}

.comp-field label {
  display:block;
  font-size:12px;
  font-weight:600;
  opacity:0.6;
  margin-bottom:4px;
}

.comp-input {
  width:100%;
  padding:8px 12px;
  background:var(--bg-soft);
  border:1px solid var(--border);
  border-radius:12px;
  color:var(--text);
  outline:none;
}

#comp-body {
  height:200px;
}

#send-btn {
  width:100%;
  background:linear-gradient(135deg,var(--accent),#9ff7ff);
  padding:12px;
  border-radius:12px;
  text-align:center;
  color:#02121f;
  font-weight:700;
  cursor:pointer;
  margin-top:16px;
}

/* AUTOCOMPLETE */
#ac-list {
  position:absolute;
  background:var(--bg-soft);
  border:1px solid var(--border);
  border-radius:12px;
  width:calc(100% - 24px);
  display:none;
  z-index:200000;
}

.ac-item {
  padding:10px 12px;
  cursor:pointer;
  border-bottom:1px solid rgba(95,199,207,0.1);
}

.ac-item:hover {
  background:rgba(95,199,207,0.15);
  color:#fff;
}

</style>
</head>

<body>
<div id="app">

  <!-- SIDEBAR -->
  <div id="sidebar">
    <div id="compose-btn">➤ Compose</div>
    <div class="sb-title">Mailboxes</div>
    <div class="sb-item active" data-box="inbox">Inbox</div>
    <div class="sb-item" data-box="sent">Sent</div>
    <div class="sb-item" data-box="starred">Starred</div>
    <div class="sb-item" data-box="junk">Junk</div>
    <div class="sb-item" data-box="drafts">Drafts</div>
    <div class="sb-item" data-box="trash">Trash</div>
  </div>

  <!-- TOPBAR -->
  <div id="topbar">
    <div id="user-email"></div>
    <input type="text" id="search-box" placeholder="Search mail…" />
  </div>

  <!-- MAIN AREA -->
  <div id="main">
    <div id="mail-list"></div>
    <div id="mail-view">
      <div id="mv-subject">Select a message</div>
      <div id="mv-meta"></div>
      <div id="mv-body"></div>
    </div>
  </div>

</div>

<!-- ============================================================
   COMPOSE MODAL
============================================================ -->
<div id="compose-modal">
  <div id="compose-box">
    <div class="comp-field">
      <label>To</label>
      <input class="comp-input" id="comp-to" autocomplete="off" />
      <div id="ac-list"></div>
    </div>

    <div class="comp-field">
      <label>CC</label>
      <input class="comp-input" id="comp-cc" />
    </div>

    <div class="comp-field">
      <label>Subject</label>
      <input class="comp-input" id="comp-subject" />
    </div>

    <div class="comp-field">
      <label>Message</label>
      <textarea class="comp-input" id="comp-body"></textarea>
    </div>

    <div id="send-btn">Send Email</div>
  </div>
</div>

<script>
/* ============================================================
   CONFIG
============================================================ */
const AIRTABLE_BASE   = "BASE_ID";
const TABLE_MAIL      = "TABLE_EMAILS";
const TABLE_EMP       = "TABLE_EMPLOYEES";
const MAKE_WEBHOOK    = "https://hook.us2.make.com/8gexssqhvek73vux4i9xxlm9l06t1a5e";

let EMPLOYEES = [];
let MAILBOX = [];
let CURRENT_BOX = "inbox";
let USER_EMAIL = "";

/* ============================================================
   INIT
============================================================ */
(async function init(){
  USER_EMAIL = prompt("Your SKANDI email:");
  document.getElementById("user-email").textContent = USER_EMAIL;

  await loadEmployees();
  await loadMailbox("inbox");

  renderMailbox();
})();

/* ============================================================
   LOAD EMPLOYEES (autocomplete)
============================================================ */
async function loadEmployees(){
  const url =
`https://api.airtable.com/v0/${AIRTABLE_BASE}/${TABLE_EMP}?pageSize=100`;
  const r = await fetch(url,{
    headers:{Authorization:"Bearer " + "YOUR_AIRTABLE_KEY"}
  });
  const d = await r.json();
  EMPLOYEES = d.records.map(r=>({
    name:r.fields.Name,
    email:r.fields.Email
  }));
}

/* ============================================================
   LOAD MAILBOX
============================================================ */
async function loadMailbox(box){
  CURRENT_BOX = box;

  const url =
`https://api.airtable.com/v0/${AIRTABLE_BASE}/${TABLE_MAIL}?filterByFormula=AND({To}='${USER_EMAIL}',{Folder}='${box}')`;

  const r = await fetch(url,{
    headers:{Authorization:"Bearer " + "YOUR_AIRTABLE_KEY"}
  });

  const d = await r.json();
  MAILBOX = d.records
    .map(r=>({
      id:r.id,
      from:r.fields.From,
      subject:r.fields.Subject,
      body:r.fields.Body,
      time:r.fields.Timestamp,
      unread:r.fields.Unread
    }))
    .sort((a,b)=> new Date(b.time)-new Date(a.time));
}

/* ============================================================
   RENDER MAILBOX
============================================================ */
async function renderMailbox(){
  const wrap = document.getElementById("mail-list");
  wrap.innerHTML = "";

  MAILBOX.forEach(m=>{
    const el = document.createElement("div");
    el.className = "mail-item" + (m.unread ? " unread" : "");
    el.innerHTML = `
      <div class="mi-from">${m.from}</div>
      <div class="mi-subject">${m.subject}</div>
      <div class="mi-time">${new Date(m.time).toLocaleString()}</div>
    `;
    el.onclick = ()=>openMessage(m);
    wrap.appendChild(el);
  });
}

/* ============================================================
   OPEN MESSAGE
============================================================ */
function openMessage(m){
  document.getElementById("mv-subject").textContent = m.subject;
  document.getElementById("mv-meta").textContent =
    `From: ${m.from} • ${new Date(m.time).toLocaleString()}`;
  document.getElementById("mv-body").textContent = m.body;
}

/* ============================================================
   COMPOSE EMAIL
============================================================ */
document.getElementById("compose-btn").onclick = ()=>{
  document.getElementById("compose-modal").style.display="flex";
};

document.getElementById("compose-modal").onclick = e=>{
  if(e.target.id==="compose-modal")
    document.getElementById("compose-modal").style.display="none";
};

/* ============================================================
   AUTOCOMPLETE
============================================================ */
document.getElementById("comp-to").addEventListener("input",()=>{
  const val = document.getElementById("comp-to").value.toLowerCase();
  const box = document.getElementById("ac-list");

  if(!val){
    box.style.display="none";
    return;
  }

  const results = EMPLOYEES.filter(e=>
     e.name.toLowerCase().includes(val) ||
     e.email.toLowerCase().includes(val)
  ).slice(0,6);

  if(!results.length){
    box.style.display="none";
    return;
  }

  box.innerHTML = "";
  results.forEach(r=>{
    const i = document.createElement("div");
    i.className="ac-item";
    i.textContent = `${r.name} <${r.email}>`;
    i.onclick = ()=>{
      document.getElementById("comp-to").value =
      `${r.name} <${r.email}>`;
      box.style.display="none";
    };
    box.appendChild(i);
  });

  box.style.display="block";
});

/* ============================================================
   SEND EMAIL (via MAKE.COM)
============================================================ */
document.getElementById("send-btn").onclick = async()=>{
  const payload = {
    from: USER_EMAIL,
    to: document.getElementById("comp-to").value,
    cc: document.getElementById("comp-cc").value,
    subject: document.getElementById("comp-subject").value,
    body: document.getElementById("comp-body").value,
  };

  await fetch(MAKE_WEBHOOK,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(payload)
  });

  alert("Email sent");
  document.getElementById("compose-modal").style.display="none";

  await loadMailbox("sent");
  renderMailbox();
};

/* ============================================================
   SIDEBAR NAV
============================================================ */
document.querySelectorAll(".sb-item").forEach(i=>{
  i.onclick = async()=>{
    document.querySelectorAll(".sb-item").forEach(x=>x.classList.remove("active"));
    i.classList.add("active");

    const box = i.dataset.box;
    await loadMailbox(box);
    renderMailbox();
  };
});

/* ============================================================
   SEARCH
============================================================ */
document.getElementById("search-box").addEventListener("input",()=>{
  const q = document.getElementById("search-box").value.toLowerCase();
  const filtered = MAILBOX.filter(m=>
    m.subject.toLowerCase().includes(q) ||
    m.body.toLowerCase().includes(q) ||
    m.from.toLowerCase().includes(q)
  );

  const wrap = document.getElementById("mail-list");
  wrap.innerHTML="";

  filtered.forEach(m=>{
    const el=document.createElement("div");
    el.className="mail-item"+(m.unread?" unread":"");
    el.innerHTML"= `
      <div class="mi-from">${m.from}</div>
      <div class="mi-subject">${m.subject}</div>
      <div class="mi-time">${new Date(m.time).toLocaleString()}</div>
    `;
    el.onclick = ()=>openMessage(m);
    wrap.appendChild(el);
  });
});
</script>
</body>
</html>
